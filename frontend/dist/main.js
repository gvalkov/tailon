function formatBytes(size){for(var i=0;1024<=size;)size/=1024,++i;return size.toFixed(1)+" "+["B","KB","MB","GB","TB","PB","EB","ZB","YB"][i]}function formatFilename(state){if(!state.id)return state.text;var size=formatBytes($(state.element).data("size"));return"<span>"+state.text+'</span><span style="float:right;">'+size+"</span>"}function endsWith(str,suffix){return-1!==str.indexOf(suffix,str.length-suffix.length)}function startsWith(str,prefix){return 0===str.indexOf(prefix)}var escape_entity_map={"&":"&amp;","<":"&lt;",">":"&gt;","/":"&#x2F;"};function escapeHtml(str){return String(str).replace(/[&<>\/]/g,function(s){return escape_entity_map[s]})}function parseQueryString(str){var res={};return str.substr(1).split("&").forEach(function(key){var value=key.split("="),key=value[0],value=value[1]&&decodeURIComponent(value[1]);key in res?res[key].push(value):res[key]=[value]}),res}function lineTypeLog(n8){var n1=n8.search(".EMERGENCY: "),n2=n8.search(".ALERT: "),n3=n8.search(".CRITICAL: "),n4=n8.search(".ERROR: "),n5=n8.search(".WARNING: "),n6=n8.search(".NOTICE: "),n7=n8.search(".INFO: "),n8=n8.search(".DEBUG: ");return 0<=n1?"EMERGENCY":0<=n2?"ALERT":0<=n3?"CRITICAL":0<=n4?"ERROR":0<=n5?"WARNING":0<=n6?"NOTICE":0<=n7?"INFO":0<=n8?"DEBUG":""}Vue.component("logview",{template:'<div class="log-view"></div>',props:["linesOfHistory"],data:function(){return{history:[],lastSpan:null,lastSpanClasses:"",autoScroll:!0}},watch:{linesOfHistory:function(val){this.trimHistory()}},methods:{clearLines:function(){this.$el.innerHTML="",this.history=[],this.lastSpan=null},toggleWrapLines:function(val){this.$el.classList.toggle("log-view-wrapped",val)},createSpan:function(innerHtml,classNames){var span=document.createElement("span");return span.innerHTML=innerHtml,span.className=classNames,span},createLogEntrySpan:function(innerHtml){return this.createSpan(innerHtml,"log-entry")},createEmergencyPan:function(innerHtml){return this.createSpan(innerHtml,"log-entry log-emergency")},createAlertPan:function(innerHtml){return this.createSpan(innerHtml,"log-entry log-alert")},createCriticalPan:function(innerHtml){return this.createSpan(innerHtml,"log-entry log-critical")},createErrorPan:function(innerHtml){return this.createSpan(innerHtml,"log-entry log-error")},createWarningPan:function(innerHtml){return this.createSpan(innerHtml,"log-entry log-warning")},createNoticePan:function(innerHtml){return this.createSpan(innerHtml,"log-entry log-notice")},createInfoPan:function(innerHtml){return this.createSpan(innerHtml,"log-entry log-info")},createDebugPan:function(innerHtml){return this.createSpan(innerHtml,"log-entry log-debug")},trimHistory:function(){if(0!==this.linesOfHistory&&this.history.length>this.linesOfHistory)for(var i=0;i<this.history.length-this.linesOfHistory+1;i++)this.$el.removeChild(this.history.shift())},isScrolledToBottom:function(){var autoScrollOffset=this.$el.parentElement,autoScrollOffset=autoScrollOffset.scrollTop-(autoScrollOffset.scrollHeight-autoScrollOffset.offsetHeight);return Math.abs(autoScrollOffset)<50},scroll:function(){this.$el.parentElement.scrollTop=this.$el.parentElement.scrollHeight},write:function(logtype,span){"o"===logtype&&("EMERGENCY"==(logtype=lineTypeLog(span=escapeHtml(span).replace(/\n$/,"")))?span=span.replace(".EMERGENCY: ",'.EMERGENCY <span class="badge badge-level-emergency"><span class="mdi mdi-bug"></span> Emergency</span>: '):"ALERT"==logtype?span=span.replace(".ALERT: ",'.ALERT <span class="badge badge-level-alert"><span class="mdi mdi-bullhorn"></span> Alert</span>: '):"CRITICAL"==logtype?span=span.replace(".CRITICAL: ",'.CRITICAL <span class="badge badge-level-critical"><span class="mdi mdi-heart-pulse"></span> Critical</span>: '):"ERROR"==logtype?span=span.replace(".ERROR: ",'.ERROR <span class="badge badge-level-error"><span class="mdi mdi-alpha-e-circle"></span> Error</span>: '):"WARNING"==logtype?span=span.replace(".WARNING: ",'.WARNING <span class="badge badge-level-warning"><span class="mdi mdi-alert"></span> Warning</span>: '):"NOTICE"==logtype?span=span.replace(".NOTICE: ",'.NOTICE <span class="badge badge-level-notice"><span class="mdi mdi-alert-circle"></span> Notice</span>: '):"INFO"==logtype?span=span.replace(".INFO: ",'.INFO <span class="badge badge-level-info"><span class="mdi mdi-information"></span> Info</span>: '):"DEBUG"==logtype&&(span=span.replace(".DEBUG: ",'.DEBUG <span class="badge badge-level-debug"><span class="mdi mdi-lifebuoy"></span> Debug</span>: ')),span=this.createLogEntrySpan(span),this.writeSpans([span]))},writeSpans:function(spanArray){if(0!==spanArray.length){for(var scrollAfterWrite=this.isScrolledToBottom(),fragment=document.createDocumentFragment(),i=0;i<spanArray.length;i++){var span=spanArray[i];this.history.push(span),fragment.appendChild(span)}this.lastSpan&&(this.lastSpan.className=this.lastSpanClasses),this.$el.appendChild(fragment),this.trimHistory(),this.autoScroll&&scrollAfterWrite&&this.scroll(),this.lastSpan=this.history[this.history.length-1],this.lastSpanClasses=this.lastSpan.className,this.lastSpan.className=this.lastSpanClasses+" log-entry-current"}}}}),Vue.component("multiselect",window.VueMultiselect.default),Vue.component("vue-loading",window.VueLoading);var apiURL=endsWith(window.relativeRoot,"/")?"ws":"/ws",apiURL=[window.location.protocol,"//",window.location.host,window.relativeRoot,apiURL].join(""),app=new Vue({el:"#app",delimiters:["<%","%>"],data:{relativeRoot:relativeRoot,commandScripts:commandScripts,fileList:[],allowCommandNames:allowCommandNames,allowDownload:allowDownload,file:null,command:null,script:null,linesOfHistory:2e3,linesToTail:10,wrapLines:!1,hideToolbar:!1,showConfig:!1,showLoadingOverlay:!1,socket:null,isConnected:!1},created:function(){this.backendConnect(),this.command=this.allowCommandNames[0]},computed:{scriptInputEnabled:function(){return""!==this.commandScripts[this.command]},downloadLink:function(){return this.file?relativeRoot+"files/?path="+this.file.path:"#"}},methods:{clearLogview:function(){this.$refs.logview.clearLines()},backendConnect:function(){this.showLoadingOverlay=!0,this.socket=new SockJS(apiURL),this.socket.onopen=this.onBackendOpen,this.socket.onclose=this.onBackendClose,this.socket.onmessage=this.onBackendMessage},onBackendOpen:function(){this.isConnected=!0,this.refreshFiles()},onBackendClose:function(){this.isConnected=!1,backendConnect=this.backendConnect,window.setTimeout(function(){backendConnect()},1e3)},onBackendMessage:function(line){var fileList,stream,data=JSON.parse(line.data);data.constructor===Object?(fileList=[],Object.keys(data).forEach(function(key){var group="__default__"===key?"Ungrouped Files":key;fileList.push({group:group,files:data[key]})}),this.fileList=fileList,this.file||(this.file=fileList[0].files[0])):(stream=data[0],line=data[1],this.$refs.logview.write(stream,line))},refreshFiles:function(){this.socket.send("list")},notifyBackend:function(){var msg={command:this.command,script:this.script,entry:this.file,nlines:this.linesToTail};this.clearLogview(),this.socket.send(JSON.stringify(msg))}},watch:{isConnected:function(val){this.showLoadingOverlay=!val},wrapLines:function(val){this.$refs.logview.toggleWrapLines(val)},command:function(val){val&&this.isConnected&&(this.script=this.commandScripts[val],this.notifyBackend())},file:function(val){val&&this.isConnected&&this.notifyBackend()}}});
